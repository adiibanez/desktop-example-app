name: "Build binaries matrix"

on: [ "push", "pull_request" ]

env:
  OTP_GITHUB_URL: https://github.com/erlang/otp.git
  WXWIDGETS_REPO: https://github.com/wxWidgets/wxWidgets.git
  WXWIDGETS_VERSION: master
  DOCKER_BUILDKIT: 0
  ACTIONS_STEP_DEBUG: true

jobs:
  build:
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 90
    strategy:
      matrix:
        otp_version: [OTP-24.3.4.14]
        elixir:
          - { version: 1.16.3, variant: "-otp-24" }
        platform: [ubuntu-latest, macos-14, windows-latest]
        include:
          - platform: ubuntu-latest
            generic_platform: linux-x86
          - platform: macos-14
            generic_platform: macos
          - platform: windows-latest
            generic_platform: windows

    name: Build Erlang/OTP ( ${{ matrix.generic_platform }} )
    env:
      OTP_VERSION: ${{ matrix.otp_version }}
      ELIXIR_VERSION: ${{ matrix.elixir.version }}
      ELIXIR_VARIANT: ${{ matrix.elixir.variant }}

    steps:
      - uses: actions/checkout@v4 # MUST be before ANY local actions and cache restores

      - name: Set platform output
        id: set-platform
        run: echo "::set-output name=PLATFORM::${{ matrix.generic_platform }}"

      - name: ASDF Cache Key
        id: asdf-cache-key
        shell: bash
        run: echo "::set-output name=key::asdf-${{ matrix.generic_platform }}-${{ env.OTP_VERSION }}-${{ env.ELIXIR_VERSION }}-$(sha256sum ~/.asdf | awk '{print $1}')"

      - name: Print ASDF Cache Key
        run: |
          echo "ASDF Cache Key: ${{ steps.asdf-cache-key.outputs.key }}"

      # - name: Restore ASDF Cache
      #   id: asdf-cache-restore
      #   uses: actions/cache/restore@v3
      #   with:
      #     path: ~/.asdf
      #     key: ${{ steps.asdf-cache-key.outputs.key }}

      - name: Determine cache name
        id: cache-name
        run: |
          echo "::set-output name=cache_name::${{ matrix.generic_platform }}-deps-${{ env.WXWIDGETS_VERSION }}-otp-${{ env.OTP_VERSION }}-${{ hashFiles('mix.lock', 'assets/package-lock.json') }}"

      - name: Print Build Cache Key
        run: |
          echo "Build Cache Key: ${{ steps.cache-name.outputs.cache_name }}"

      - name: Restore Build Cache
        uses: actions/cache/restore@v3
        #id: deps-cache
        id: deps-cache
        with:
          path: |
            deps
            _build
            assets/node_modules
            ${{ steps.set-platform.outputs.PLATFORM == 'windows' && 'c:\\opt\\otp.exe' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'windows' && 'c:\\opt\\local64\\pgm\\wxWidgets-3.x.x' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'macos' && '~/projects/wxWidgets' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'macos' && '/usr/local/wxWidgets' || '' }}
          key: ${{ steps.cache-name.outputs.cache_name }}
          restore-keys: |
            ${{ matrix.generic_platform }}-deps-${{ env.WXWIDGETS_VERSION }}-otp-${{ env.OTP_VERSION }}-
            ${{ matrix.generic_platform }}-deps-${{ env.WXWIDGETS_VERSION }}-
            ${{ matrix.generic_platform }}-deps-

      - name: Install ASDF (Linux)
        if: matrix.generic_platform == 'linux-x86' && steps.asdf-cache-restore.outputs.cache-hit != 'true'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl
          git clone https://github.com/asdf-vm/asdf.git ~/.asdf
          # --branch v0.8.1
          echo ". $HOME/.asdf/asdf.sh" >> ~/.profile
          source ~/.profile

          asdf --version
          asdf list all elixir
          asdf plugin list all

      - name: Install ASDF (macOS)
        if: matrix.generic_platform == 'macos' && steps.asdf-cache-restore.outputs.cache-hit != 'true'
        shell: bash
        run: |
          brew install coreutils automake autoconf libtool git asdf
          #echo 'export PATH="/opt/homebrew/opt/libtool/libexec/gnubin:$PATH"' >> ~/.profile
          #export PATH="/opt/homebrew/opt/libtool/libexec/gnubin:$PATH" # For current session
          #git clone https://github.com/asdf-vm/asdf.git ~/.asdf
          # --branch v0.8.1
          echo ". $HOME/.asdf/asdf.sh" >> ~/.profile
          source  ~/.profile

          asdf --version
          asdf list all elixir
          asdf plugin list all

      - name: Install ASDF (Windows)
        if: matrix.generic_platform == 'windows' && steps.asdf-cache-restore.outputs.cache-hit != 'true'
        shell: bash
        run: |
          # Assumes WSL is configured
          apt-get update
          apt-get install -y git curl
          git clone https://github.com/asdf-vm/asdf.git ~/.asdf
          # --branch v0.8.1
          echo ". $HOME/.asdf/asdf.sh" >> ~/.profile
          source ~/.profile

          asdf --version
          asdf list all elixir
          asdf plugin list all

      - name: Set up build tools
        shell: bash
        run: |
          # . $HOME/.asdf/asdf.sh
          asdf plugin add erlang
          asdf plugin add elixir
          asdf plugin add nodejs
          asdf install

      - name: Common Build Steps
        uses: ./.github/actions/common
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          elixir-variant: ${{ env.ELIXIR_VARIANT }}

      - name: "Compile and Lint"
        shell: bash
        run: |
          # . $HOME/.asdf/asdf.sh
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
          cd assets && npm install

      - name: Windows Build Steps
        if: matrix.generic_platform == 'windows'
        uses: ./.github/actions/windows
        with:
          cache-hit: ${{ steps.deps-cache.outputs.cache-hit }}
          otp-version: ${{ env.OTP_VERSION }}
          wxwidgets-version: ${{ env.WXWIDGETS_VERSION }}
          wxwidgets-repo: ${{ env.WXWIDGETS_REPO }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          elixir-variant: ${{ env.ELIXIR_VARIANT }}
          win32-key-pass: ${{ secrets.WIN32_KEY_PASS }}

      - name: macOS Build Steps
        if: matrix.generic_platform == 'macos'
        uses: ./.github/actions/macos
        with:
          cache-hit: ${{ steps.deps-cache.outputs.cache-hit }}
          otp-version: ${{ env.OTP_VERSION }}
          wxwidgets-version: ${{ env.WXWIDGETS_VERSION }}
          wxwidgets-repo: ${{ env.WXWIDGETS_REPO }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          elixir-variant: ${{ env.ELIXIR_VARIANT }}
          macos-pem: ${{ secrets.MACOS_PEM }}

      - name: Linux Build Steps
        if: matrix.generic_platform == 'linux-x86'
        uses: ./.github/actions/linux
        with:
          cache-hit: ${{ steps.deps-cache.outputs.cache-hit }}
          otp-version: ${{ env.OTP_VERSION }}
          wxwidgets-version: ${{ env.WXWIDGETS_VERSION }}
          wxwidgets-repo: ${{ env.WXWIDGETS_REPO }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
          elixir-variant: ${{ env.ELIXIR_VARIANT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

      - name: Archive Installer
        if: matrix.generic_platform != 'linux-x86'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.generic_platform }}-Installer
          path: |
            _build/prod/*.${{ matrix.generic_platform == 'windows' && 'exe' || 'dmg' }}

      - name: Archive Installer Linux
        if: matrix.generic_platform == 'linux-x86'
        uses: actions/upload-artifact@v4
        with:
          name: Linux-Installer
          path: |
            ./*.run


      - name: Save Build Cache
        if: steps.deps-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            deps
            _build
            assets/node_modules
            ${{ steps.set-platform.outputs.PLATFORM == 'windows' && 'c:\\opt\\otp.exe' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'windows' && 'c:\\opt\\local64\\pgm\\wxWidgets-3.x.x' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'macos' && '~/projects/wxWidgets' || '' }}
            ${{ steps.set-platform.outputs.PLATFORM == 'macos' && '/usr/local/wxWidgets' || '' }}
          key: ${{ steps.cache-name.outputs.cache_name }}

      # - name: Save ASDF cache
      #   uses: actions/cache/save@v3
      #   with:
      #     path: ~/.asdf
      #     key: ${{ steps.asdf-cache-key.outputs.key }}